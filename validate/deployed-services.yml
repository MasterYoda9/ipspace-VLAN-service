#
# List of tasks needed to validate deployed services
#
---
- name: Get information from the device in common data model
  include: "../getinfo/{{ansible_os}}-get.yml"

- name: "Check: service VLANs are configured"
  assert: 
    that: "item.key|string in active_vlan_list"
    msg:  "VLAN {{item.value}} id {{item.key}} is not active"
  with_dict: "{{data.vlans}}"

- name: "Check: Access VLANs are configured on service ports"
  assert: 
    that: "item.value.vlan == access_interfaces[item.key].vlan|default('MISSING')"
    msg:  "VLAN {{item.value.vlan}} is not access VLAN configured on {{item.key}}"
  with_dict: "{{data.ports}}"
  when: item.key != ""

- name: "Check: decomissioned service VLANs are not configured"
  assert: 
    that: "not(item|string in all_vlan_list)"
    msg:  "VLAN {{item}} is still active on {{inventory_hostname}}"
  with_items: "{{data.remove_vlans}}"

- name: "Check: decomissioned ports are not active"
  assert: 
    that: "item in disabled_interfaces"
    msg:  "Port {{item}} is not disabled on {{inventory_hostname}}"
  with_items: "{{data.remove_ports}}"
  when: item != ""
